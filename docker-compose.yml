# Best Streamlit Website - Docker Compose Configuration
# This setup provides a complete local development environment with hot-reload support

services:
  # =============================================================================
  # Core Application Services
  # =============================================================================

  streamlit:
    build:
      context: ./best-streamlit-website
      dockerfile: deploy/streamlit/Dockerfile
    container_name: bsw-streamlit
    ports:
      - "8502:8501"
    environment:
      # Scheduler MCP connection
      - SCHEDULER_MCP_TRANSPORT=http
      - SCHEDULER_MCP_URL=http://scheduler:8010
      - STREAMLIT_SCHEDULER_MCP_TRANSPORT=streamable-http
      - STREAMLIT_SCHEDULER_MCP_URL=http://scheduler:8010/mcp

      # Jenkins MCP connection
      - JENKINS_MCP_TRANSPORT=http
      - JENKINS_MCP_URL=http://jenkins-mcp:8000
      - STREAMLIT_JENKINS_MCP_TRANSPORT=streamable-http
      - STREAMLIT_JENKINS_MCP_URL=http://jenkins-mcp:8000/mcp
      - JENKINS_BASE_URL=${JENKINS_BASE_URL:-http://jenkins:8080}
      - JENKINS_VERIFY_SSL=${JENKINS_VERIFY_SSL:-false}

      # Kubernetes MCP connection
      - KUBERNETES_MCP_TRANSPORT=http
      - KUBERNETES_MCP_URL=http://kubernetes-mcp:8000
      - STREAMLIT_KUBERNETES_MCP_TRANSPORT=streamable-http
      - STREAMLIT_KUBERNETES_MCP_URL=http://kubernetes-mcp:8000/mcp

      # Docker MCP connection
      - DOCKER_MCP_TRANSPORT=http
      - DOCKER_MCP_URL=http://docker-mcp:8000
      - STREAMLIT_DOCKER_MCP_TRANSPORT=streamable-http
      - STREAMLIT_DOCKER_MCP_URL=http://docker-mcp:8000/mcp

      # Nexus MCP connection (optional)
      - NEXUS_MCP_TRANSPORT=http
      - NEXUS_MCP_URL=http://nexus-mcp:8000
      - STREAMLIT_NEXUS_MCP_TRANSPORT=streamable-http
      - STREAMLIT_NEXUS_MCP_URL=http://nexus-mcp:8000/mcp

      # Git MCP connection
      - GIT_MCP_TRANSPORT=http
      - GIT_MCP_URL=http://git-mcp:8000
      - STREAMLIT_GIT_MCP_TRANSPORT=streamable-http
      - STREAMLIT_GIT_MCP_URL=http://git-mcp:8000/mcp

      # Trivy MCP connection
      - TRIVY_MCP_TRANSPORT=http
      - TRIVY_MCP_URL=http://trivy-mcp:8000
      - STREAMLIT_TRIVY_MCP_TRANSPORT=streamable-http
      - STREAMLIT_TRIVY_MCP_URL=http://trivy-mcp:8000/mcp

      # Playwright MCP connection
      - PLAYWRIGHT_MCP_TRANSPORT=http
      - PLAYWRIGHT_MCP_URL=http://playwright-mcp:8000
      - STREAMLIT_PLAYWRIGHT_MCP_TRANSPORT=streamable-http
      - STREAMLIT_PLAYWRIGHT_MCP_URL=http://playwright-mcp:8000/mcp

      # WebSearch MCP connection
      - WEBSEARCH_MCP_TRANSPORT=http
      - WEBSEARCH_MCP_URL=http://websearch-mcp:8000
      - STREAMLIT_WEBSEARCH_MCP_TRANSPORT=streamable-http
      - STREAMLIT_WEBSEARCH_MCP_URL=http://websearch-mcp:8000/mcp

      # Ollama configuration
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://ollama:11434}
      - OLLAMA_MODEL=${OLLAMA_MODEL:-tinyllama}
      - OLLAMA_ENABLED=${OLLAMA_ENABLED:-true}

      # Database configuration (PostgreSQL)
      - DATABASE_URL=${DATABASE_URL:-postgresql+psycopg2://bsw:bsw@postgres:5432/bsw}
      - PLATFORM_DATABASE_URL=${PLATFORM_DATABASE_URL:-postgresql+psycopg2://bsw:bsw@postgres:5432/bsw}
      - MCP_LOG_DATABASE_URL=${MCP_LOG_DATABASE_URL:-postgresql+psycopg2://bsw:bsw@postgres:5432/bsw}
    volumes:
      # Hot-reload support: mount source code
      - ./best-streamlit-website:/app:cached
      # Persistent data directory
      - ./data:/app/data:delegated
    depends_on:
      - scheduler
      - docker-mcp
      - postgres
    mem_limit: 512m
    cpus: 0.5
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - bsw-network

  scheduler:
    build:
      context: ./best-streamlit-website
      dockerfile: deploy/scheduler/Dockerfile
    container_name: bsw-scheduler
    ports:
      - "8010:8010"
    environment:
      # Scheduler configuration
      - SCHEDULER_MCP_TRANSPORT=http
      - SCHEDULER_MCP_HOST=0.0.0.0
      - SCHEDULER_MCP_PORT=8010
      - SCHEDULER_TICK_SECONDS=${SCHEDULER_TICK_SECONDS:-5}
      - SCHEDULER_MAX_JOBS_PER_TICK=${SCHEDULER_MAX_JOBS_PER_TICK:-20}
      - SCHEDULER_BOOTSTRAP_JOBS=${SCHEDULER_BOOTSTRAP_JOBS:-true}
      - SCHEDULER_BOOTSTRAP_ALLOW_SHARED=${SCHEDULER_BOOTSTRAP_ALLOW_SHARED:-true}

      # Database configuration
      - SCHEDULER_DATABASE_URL=${SCHEDULER_DATABASE_URL:-postgresql+psycopg2://bsw:bsw@postgres:5432/bsw}
      - PLATFORM_DATABASE_URL=${PLATFORM_DATABASE_URL:-postgresql+psycopg2://bsw:bsw@postgres:5432/bsw}

      # MCP server connections for scheduled jobs
      - JENKINS_MCP_TRANSPORT=http
      - JENKINS_MCP_URL=http://jenkins-mcp:8000
      - KUBERNETES_MCP_TRANSPORT=http
      - KUBERNETES_MCP_URL=http://kubernetes-mcp:8000
      - DOCKER_MCP_TRANSPORT=http
      - DOCKER_MCP_URL=http://docker-mcp:8000
      - NEXUS_MCP_TRANSPORT=http
      - NEXUS_MCP_URL=http://nexus-mcp:8000
    volumes:
      # Hot-reload support
      - ./best-streamlit-website/src:/app/src:cached
      # Persistent data
      - ./data:/app/data:delegated
    mem_limit: 256m
    cpus: 0.25
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8010/health"]
      interval: 20s
      timeout: 5s
      retries: 3
      start_period: 20s
    networks:
      - bsw-network

  postgres:
    image: postgres:16-alpine
    container_name: bsw-postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-bsw}
      - POSTGRES_USER=${POSTGRES_USER:-bsw}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-bsw}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    mem_limit: 256m
    cpus: 0.2
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - bsw-network

  # =============================================================================
  # MCP Servers
  # =============================================================================

  docker-mcp:
    build:
      context: ./best-streamlit-website
      dockerfile: deploy/mcp-docker/Dockerfile
    container_name: bsw-docker-mcp
    ports:
      - "8001:8000"
    environment:
      # Docker connection (connect to host Docker daemon)
      - DOCKER_HOST=${DOCKER_HOST:-unix:///var/run/docker.sock}
      - DOCKER_MCP_TRANSPORT=http
      - DOCKER_MCP_HOST=0.0.0.0
      - DOCKER_MCP_PORT=8000
      # Explicit FastMCP overrides so the HTTP server listens on all interfaces
      - MCP_TRANSPORT=http
      - MCP_HOST=0.0.0.0
      - MCP_PORT=8000
    volumes:
      # Mount Docker socket to communicate with host daemon
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Hot-reload support
      - ./best-streamlit-website/src:/app/src:cached
    mem_limit: 128m
    cpus: 0.1
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 20s
      timeout: 5s
      retries: 3
    networks:
      - bsw-network

  jenkins-mcp:
    build:
      context: ./best-streamlit-website
      dockerfile: deploy/mcp-jenkins/Dockerfile
    container_name: bsw-jenkins-mcp
    ports:
      - "8002:8000"
    environment:
      # Jenkins connection
      - JENKINS_BASE_URL=${JENKINS_BASE_URL:-http://jenkins:8080}
      - JENKINS_USERNAME=${JENKINS_USERNAME:-}
      - JENKINS_API_TOKEN=${JENKINS_API_TOKEN:-}
      - JENKINS_VERIFY_SSL=${JENKINS_VERIFY_SSL:-false}

      # MCP server configuration
      - JENKINS_MCP_TRANSPORT=http
      - JENKINS_MCP_HOST=0.0.0.0
      - JENKINS_MCP_PORT=8000
      # Explicit FastMCP overrides
      - MCP_TRANSPORT=http
      - MCP_HOST=0.0.0.0
      - MCP_PORT=8000
      - JENKINS_MCP_CLIENT_TOKEN=${JENKINS_MCP_CLIENT_TOKEN:-dev-jenkins-mcp-token}
    volumes:
      # Hot-reload support
      - ./best-streamlit-website/src:/app/src:cached
    mem_limit: 256m
    cpus: 0.25
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/health || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 3
    networks:
      - bsw-network

  kubernetes-mcp:
    build:
      context: ./best-streamlit-website
      dockerfile: deploy/mcp-kubernetes/Dockerfile
    container_name: bsw-kubernetes-mcp
    ports:
      - "8003:8000"
    environment:
      # Kubernetes connection (uses kubeconfig from host)
      - K8S_KUBECONFIG=${K8S_KUBECONFIG:-}
      - K8S_CONTEXT=${K8S_CONTEXT:-}

      # MCP server configuration
      - KUBERNETES_MCP_TRANSPORT=http
      - KUBERNETES_MCP_HOST=0.0.0.0
      - KUBERNETES_MCP_PORT=8000
      # Explicit FastMCP overrides
      - MCP_TRANSPORT=http
      - MCP_HOST=0.0.0.0
      - MCP_PORT=8000
    volumes:
      # Mount kubeconfig if available (use USERPROFILE on Windows, HOME on Linux)
      - ${USERPROFILE:-${HOME}}/.kube:/root/.kube:ro
      # Hot-reload support
      - ./best-streamlit-website/src:/app/src:cached
    mem_limit: 256m
    cpus: 0.25
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/health || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 3
    networks:
      - bsw-network

  nexus-mcp:
    build:
      context: ./best-streamlit-website
      dockerfile: deploy/mcp-jenkins/Dockerfile  # Reuse Jenkins Dockerfile as template
    container_name: bsw-nexus-mcp
    ports:
      - "8004:8000"
    environment:
      # Nexus connection
      - NEXUS_BASE_URL=${NEXUS_BASE_URL:-http://nexus:8081}
      - NEXUS_USERNAME=${NEXUS_USERNAME:-}
      - NEXUS_PASSWORD=${NEXUS_PASSWORD:-}

      # MCP server configuration
      - NEXUS_MCP_TRANSPORT=http
      - NEXUS_MCP_HOST=0.0.0.0
      - NEXUS_MCP_PORT=8000
    volumes:
      - ./best-streamlit-website/src:/app/src:cached
    mem_limit: 128m
    cpus: 0.1
    restart: unless-stopped
    networks:
      - bsw-network

  git-mcp:
    build:
      context: ./best-streamlit-website
      dockerfile: deploy/mcp-git/Dockerfile
    container_name: bsw-git-mcp
    ports:
      - "8005:8000"
    environment:
      # MCP server configuration
      - GIT_MCP_TRANSPORT=http
      - GIT_MCP_HOST=0.0.0.0
      - GIT_MCP_PORT=8000
      # Explicit FastMCP overrides
      - MCP_TRANSPORT=http
      - MCP_HOST=0.0.0.0
      - MCP_PORT=8000
    volumes:
      # Mount workspace for git operations (configurable)
      - ${GIT_WORKSPACE:-./data/repos}:/repos:cached
      # Hot-reload support
      - ./best-streamlit-website/src:/app/src:cached
    mem_limit: 128m
    cpus: 0.1
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -sf -H \"Content-Type: application/json\" -H \"Accept: application/json, text/event-stream\" -d '{\"jsonrpc\":\"2.0\",\"id\":1,\"method\":\"initialize\",\"params\":{\"protocolVersion\":\"2025-11-25\",\"capabilities\":{},\"clientInfo\":{\"name\":\"bsw-health\",\"version\":\"1.0\"}}}' http://localhost:8000/mcp > /dev/null"]
      interval: 20s
      timeout: 5s
      retries: 3
    networks:
      - bsw-network

  trivy-mcp:
    build:
      context: ./best-streamlit-website
      dockerfile: deploy/mcp-trivy/Dockerfile
    container_name: bsw-trivy-mcp
    ports:
      - "8006:8000"
    environment:
      # MCP server configuration
      - TRIVY_MCP_TRANSPORT=http
      - TRIVY_MCP_HOST=0.0.0.0
      - TRIVY_MCP_PORT=8000
      # Explicit FastMCP overrides
      - MCP_TRANSPORT=http
      - MCP_HOST=0.0.0.0
      - MCP_PORT=8000
      # Trivy configuration
      - TRIVY_SEVERITY=${TRIVY_SEVERITY:-CRITICAL,HIGH,MEDIUM,LOW}
      - TRIVY_SKIP_DB_UPDATE=${TRIVY_SKIP_DB_UPDATE:-false}
    volumes:
      # Trivy cache for vulnerability database
      - trivy-cache:/root/.cache/trivy
      # Hot-reload support
      - ./best-streamlit-website/src:/app/src:cached
    mem_limit: 512m
    cpus: 0.5
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -sf -H \"Content-Type: application/json\" -H \"Accept: application/json, text/event-stream\" -d '{\"jsonrpc\":\"2.0\",\"id\":1,\"method\":\"initialize\",\"params\":{\"protocolVersion\":\"2025-11-25\",\"capabilities\":{},\"clientInfo\":{\"name\":\"bsw-health\",\"version\":\"1.0\"}}}' http://localhost:8000/mcp > /dev/null"]
      interval: 20s
      timeout: 5s
      retries: 3
    networks:
      - bsw-network

  playwright-mcp:
    build:
      context: ./best-streamlit-website
      dockerfile: deploy/mcp-playwright/Dockerfile
    container_name: bsw-playwright-mcp
    ports:
      - "8007:8000"
    environment:
      # MCP server configuration
      - PLAYWRIGHT_MCP_TRANSPORT=http
      - PLAYWRIGHT_MCP_HOST=0.0.0.0
      - PLAYWRIGHT_MCP_PORT=8000
      # Explicit FastMCP overrides
      - MCP_TRANSPORT=http
      - MCP_HOST=0.0.0.0
      - MCP_PORT=8000
      # Playwright configuration
      - PLAYWRIGHT_HEADLESS=${PLAYWRIGHT_HEADLESS:-true}
      - PLAYWRIGHT_BROWSER=${PLAYWRIGHT_BROWSER:-chromium}
    volumes:
      # Screenshots output directory
      - ./data/playwright:/tmp/playwright
      # Hot-reload support
      - ./best-streamlit-website/src:/app/src:cached
    mem_limit: 512m
    cpus: 0.5
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -sf -H \"Content-Type: application/json\" -H \"Accept: application/json, text/event-stream\" -d '{\"jsonrpc\":\"2.0\",\"id\":1,\"method\":\"initialize\",\"params\":{\"protocolVersion\":\"2025-11-25\",\"capabilities\":{},\"clientInfo\":{\"name\":\"bsw-health\",\"version\":\"1.0\"}}}' http://localhost:8000/mcp > /dev/null"]
      interval: 20s
      timeout: 5s
      retries: 3
    networks:
      - bsw-network

  websearch-mcp:
    build:
      context: ./best-streamlit-website
      dockerfile: deploy/mcp-websearch/Dockerfile
    container_name: bsw-websearch-mcp
    ports:
      - "8008:8000"
    environment:
      # MCP server configuration
      - WEBSEARCH_MCP_TRANSPORT=http
      - WEBSEARCH_MCP_HOST=0.0.0.0
      - WEBSEARCH_MCP_PORT=8000
      # Explicit FastMCP overrides
      - MCP_TRANSPORT=http
      - MCP_HOST=0.0.0.0
      - MCP_PORT=8000
      # WebSearch configuration
      - WEBSEARCH_MAX_RESULTS=${WEBSEARCH_MAX_RESULTS:-10}
      - WEBSEARCH_REGION=${WEBSEARCH_REGION:-wt-wt}
      - WEBSEARCH_SAFESEARCH=${WEBSEARCH_SAFESEARCH:-moderate}
    volumes:
      # Hot-reload support
      - ./best-streamlit-website/src:/app/src:cached
    mem_limit: 128m
    cpus: 0.1
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -sf -H \"Content-Type: application/json\" -H \"Accept: application/json, text/event-stream\" -d '{\"jsonrpc\":\"2.0\",\"id\":1,\"method\":\"initialize\",\"params\":{\"protocolVersion\":\"2025-11-25\",\"capabilities\":{},\"clientInfo\":{\"name\":\"bsw-health\",\"version\":\"1.0\"}}}' http://localhost:8000/mcp > /dev/null"]
      interval: 20s
      timeout: 5s
      retries: 3
    networks:
      - bsw-network

  # =============================================================================
  # AI Services (Optional)
  # =============================================================================

  ollama:
    image: ollama/ollama:latest
    container_name: bsw-ollama
    restart: unless-stopped
    ports:
      - "11434:11434"
    environment:
      - OLLAMA_HOST=0.0.0.0
      - OLLAMA_NUM_CTX=32768
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    volumes:
      - ollama_data:/root/.ollama
    healthcheck:
      # Query tags endpoint; it's stable once server is ready
      test: ["CMD", "curl", "-fsS", "http://localhost:11434/api/tags"]
      interval: 10s
      timeout: 5s
      retries: 10
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4096MiB
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    profiles:
      - notai  # Only start with --profile ai

# =============================================================================
# Networks
# =============================================================================

networks:
  bsw-network:
    name: best-streamlit-network
    driver: bridge

# =============================================================================
# Volumes
# =============================================================================

volumes:
  ollama-data:
    name: bsw-ollama-data
  trivy-cache:
    name: bsw-trivy-cache
  postgres-data:
    name: bsw-postgres-data
